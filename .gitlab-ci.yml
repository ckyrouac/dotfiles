# GitLab CI/CD Pipeline for Fedora Dev Bootc Image
# Equivalent to .github/workflows/bootc.yaml

stages:
  - rechunk

variables:
  IMAGE_REGISTRY: $CI_REGISTRY

.free_disk_space: &free_disk_space
  # Free disk space on the runner
  - df -h
  - sudo dnf clean all || true
  - df -h

.install_podman: &install_podman
  # Install podman on Fedora
  - |
    set -euxo pipefail
    sudo dnf install -y podman skopeo

rechunk-desktop:
  stage: rechunk
  image: ubuntu:24.04
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CI_PIPELINE_SOURCE == "schedule"
  before_script:
    - *free_disk_space
    - *install_podman
    - podman login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - |
      set -euxo pipefail
      IMAGE_BASE="${CI_REGISTRY}/${CI_PROJECT_PATH}/bootc-desktop"
      podman pull "${IMAGE_BASE}:chunked"
      podman run --rm --privileged \
        -v /var/lib/containers/storage:/var/lib/containers/storage \
        "${IMAGE_BASE}:chunked" \
        sh -c "rpm-ostree compose build-chunked-oci --bootc --from=${IMAGE_BASE}:latest --output=containers-storage:${IMAGE_BASE}:chunked --format-version=2"
      podman push "${IMAGE_BASE}:chunked"
      # push a second time to preserve layer annotations
      podman push "${IMAGE_BASE}:chunked"
