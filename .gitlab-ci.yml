# GitLab CI/CD Pipeline for Fedora Dev Bootc Image
# Equivalent to .github/workflows/bootc.yaml

stages:
  - rechunk

.install_podman: &install_podman
  # Install podman on Fedora
  - |
    set -euxo pipefail
    sudo dnf install -y podman skopeo

rechunk-desktop:
  stage: rechunk
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CI_PIPELINE_SOURCE == "schedule"
  before_script:
    - *install_podman
    - podman login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - |
      set -euxo pipefail
      IMAGE_BASE="${CI_REGISTRY}/${CI_PROJECT_PATH}/bootc-desktop"

      # Build the image with :latest tag
      podman build -t "${IMAGE_BASE}:latest" -f Desktop.containerfile .

      # Try to pull the chunked tag if it exists (for layer caching)
      # If it doesn't exist, use :latest as the base for rechunking
      if podman pull "${IMAGE_BASE}:chunked"; then
        RECHUNK_IMAGE="${IMAGE_BASE}:chunked"
      else
        RECHUNK_IMAGE="${IMAGE_BASE}:latest"
      fi

      # Rechunk from the base image and output to chunked tag
      rpm-ostree compose build-chunked-oci --bootc --from=${IMAGE_BASE}:latest --output=containers-storage:${IMAGE_BASE}:chunked --format-version=2

      # Push both tags
      podman push "${IMAGE_BASE}:chunked"
      podman push "${IMAGE_BASE}:latest"
