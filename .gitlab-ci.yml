# GitLab CI/CD Pipeline for Fedora Dev Bootc Image
# Equivalent to .github/workflows/bootc.yaml

stages:
  - build-base
  - build-desktop

.common:
  timeout: 8 hours
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CI_PIPELINE_SOURCE == "schedule"
  before_script:
    - |
      set -euxo pipefail
      sudo dnf install -y podman skopeo
    - podman login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

build-base:
  extends: .common
  stage: build-base
  script:
    - |
      set -euxo pipefail
      IMAGE_BASE="${CI_REGISTRY}/${CI_PROJECT_PATH}/bootc-base"

      podman build -t "${IMAGE_BASE}:latest" \
        --no-cache \
        --platform amd64 \
        -f Containerfile .

      podman push "${IMAGE_BASE}:latest"

build-desktop:
  extends: .common
  stage: build-desktop
  needs:
    - build-base
  script:
    - |
      set -euxo pipefail
      IMAGE_BASE="${CI_REGISTRY}/${CI_PROJECT_PATH}/bootc-base"
      IMAGE_DESKTOP="${CI_REGISTRY}/${CI_PROJECT_PATH}/bootc-desktop"

      podman build -t "${IMAGE_DESKTOP}:latest" \
        --platform amd64 \
        --no-cache \
        --build-arg BASE_IMAGE="${IMAGE_BASE}:latest" \
        -f Desktop.containerfile .

      # Try to pull the existing chunked tag for rpm-ostree to use as baseline
      podman pull "${IMAGE_DESKTOP}:chunked" || true

      rpm-ostree compose build-chunked-oci --bootc --from=${IMAGE_DESKTOP}:latest --output=containers-storage:${IMAGE_DESKTOP}:chunked --format-version=2

      # Push both tags
      podman push "${IMAGE_DESKTOP}:chunked"
      podman push "${IMAGE_DESKTOP}:latest"
