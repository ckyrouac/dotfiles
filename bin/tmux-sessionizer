#!/usr/bin/env bash
#
# Based off https://github.com/ThePrimeagen/.dotfiles/blob/602019e902634188ab06ea31251c01c1a43d1621/bin/.local/scripts/tmux-sessionizer
#

SESSION_HISTORY_FILE="$HOME/.tmux_session_history"

# Calculate popup width: 20% of terminal, minimum 80 columns
function popup_width() {
    local term_width width
    term_width=$(tput cols 2>/dev/null || echo 200)
    width=$((term_width * 20 / 100))
    if [ "$width" -lt 50 ]; then
        width=50
    fi
    echo "$width"
}

function usage() {
  echo -e "Usage:\n"
  echo -e "tmux-sessionizer <switch>\n"

  printf "%-25s %s\n" "Switches:" ""
  printf "%-25s %s\n" "-a, --all" "All projects in defined directories"
  printf "%-25s %s\n" "-e, --existing" "Existing tmux sessions"
  printf "%-25s %s\n" "-s, --session" "Specify the session to switch to"

  printf "%-25s %s\n" "" ""
  printf "%-25s %s\n" "-h, --help" ""
}

function args()
{
    options=$(getopt -o p:haesk --long session --long kill --long help --long existing --long all -- "$@")
    option_code=$?
    [ "$option_code" -eq 0 ] || {
        echo "Incorrect option provided"
        usage
        exit 1
    }
    eval set -- "$options"
    i=0
    while true; do
        case "$1" in
        -a)
          ALL=true
          i=$((i+1))
          ;;
        --all)
          ALL=true
          i=$((i+1))
          ;;
        -k)
          KILL=true
          i=$((i+1))
          ;;
        --kill)
          KILL=true
          i=$((i+1))
          ;;
        -e)
          EXISTING=true
          i=$((i+1))
          ;;
        --existing)
          EXISTING=true
          i=$((i+1))
          ;;
        -s)
          SESSION=true
          i=$((i+1))
          ;;
        --session)
          SESSION=true
          i=$((i+1))
          ;;
        -h)
          usage
          exit 1;
          ;;
        --help)
          usage
          exit 1;
          ;;
        --)
        shift
        break
        ;;
        esac
        shift
    done
}

args "$0" "$@"

# prevent multiple switches
num_switches=$i
if [ "$num_switches" -gt 1 ]; then
    echo "Only one switch can be used at a time"
    usage
    exit 1
fi

# Record session to history file (most recent at top)
function record_session_history()
{
    local session="$1"
    if [[ -z "$session" ]]; then
        return
    fi

    # Create file if it doesn't exist
    touch "$SESSION_HISTORY_FILE"

    # Remove session from history if it exists, then add to top
    local temp_file
    temp_file=$(mktemp)
    echo "$session" > "$temp_file"
    grep -v "^${session}$" "$SESSION_HISTORY_FILE" >> "$temp_file" 2>/dev/null
    mv "$temp_file" "$SESSION_HISTORY_FILE"
}

# Get sessions with Claude status appended, sorted by most recently used
# Status codes: [!]=Action needed, [I]=Idle, [W]=Working
# Current session is placed at the end since user is switching away from it
function get_sessions_with_status()
{
    local sessions current_session
    current_session=$(tmux display-message -p '#S' 2>/dev/null)
    sessions=$(tmux list-sessions -F "#S" 2>/dev/null)

    # Build sorted list based on history file
    local sorted_sessions=""
    local seen_sessions=""

    # First, add sessions in history order (if they still exist)
    if [[ -f "$SESSION_HISTORY_FILE" ]]; then
        while IFS= read -r hist_session; do
            if echo "$sessions" | grep -q "^${hist_session}$"; then
                if [[ -n "$sorted_sessions" ]]; then
                    sorted_sessions="$sorted_sessions"$'\n'"$hist_session"
                else
                    sorted_sessions="$hist_session"
                fi
                seen_sessions="$seen_sessions|^${hist_session}$"
            fi
        done < "$SESSION_HISTORY_FILE"
    fi

    # Add any sessions not in history (new sessions)
    while IFS= read -r session; do
        if [[ -z "$seen_sessions" ]] || ! echo "$session" | grep -qE "${seen_sessions:1}"; then
            if [[ -n "$sorted_sessions" ]]; then
                sorted_sessions="$sorted_sessions"$'\n'"$session"
            else
                sorted_sessions="$session"
            fi
        fi
    done <<< "$sessions"

    # Output sessions, excluding current session
    while IFS= read -r session; do
        # Skip current session
        if [[ "$session" == "$current_session" ]]; then
            continue
        fi

        local claude_status
        claude_status=$(claude-session-status "$session" 2>/dev/null)
        if [[ -n "$claude_status" ]]; then
            printf "%-30s %s\n" "$session" "$claude_status"
        else
            echo "$session"
        fi
    done <<< "$sorted_sessions"
}

# Extract session name from selection (strip status suffix)
function strip_status_suffix()
{
    echo "$1" | sed 's/\s*\[[!IW]\]\s*$//' | xargs
}

function init_session()
{
    dir=$1
    session_name=$2

    tmux select-window -t "$session_name:1"
    tmux rename-window -t "$session_name:1" vim
    tmux split-window -v -l 40% -c "$dir" -t "$session_name:1"
    tmux select-pane -t "$session_name:1.1"
    tmux resize-pane -t "$session_name:1.1" -Z
    tmux send-keys -t "$session_name:1.1" "nvim" Enter
}

function switch-session()
{
    selected=$1

    if [[ -z $selected ]]; then
        exit 0
    fi

    # Record current session before switching
    if [[ -n $TMUX ]]; then
        current_session=$(tmux display-message -p '#S' 2>/dev/null)
        record_session_history "$current_session"
    fi

    type="existing"
    is_worktree=$(dirname "$selected" | xargs dirname | xargs basename) 
    if [[ "$is_worktree" == "worktrees" ]]; then
        type="worktree"
    fi
    is_project=$(dirname "$selected" | xargs basename)
    if [[ "$is_project" == "projects" ]]; then
        type="project"
    fi

    selected_name="$selected"
    if [[ "$type" == "project" ]]; then
        selected_name=$(basename "$selected" | tr . _)
    elif [[ "$type" == "worktree" ]]; then
        project_name=$(dirname "$selected" | xargs basename)
        worktree_name=$(basename "$selected")
        selected_name="$project_name/$worktree_name"
    fi

    tmux_running=$(pgrep tmux)

    if [[ -z $TMUX ]] && [[ -z $tmux_running ]]; then
        tmux new-session -s "$selected_name" -c "$selected"
        init_session "$selected" "$selected_name"
        exit 0
    fi

    if ! tmux has-session -t="$selected_name" 2> /dev/null; then
        tmux new-session -ds "$selected_name" -c "$selected"
        init_session "$selected" "$selected_name"
    fi

    tmux switch-client -t "$selected_name"
}

# default to all
if [ -z "$ALL" ] && [ -z "$EXISTING" ] && [ -z "$KILL" ] && [ -z "$SESSION" ]; then
    ALL=true
fi

if [ "$ALL" = true ]; then
    # Build list with display names and full paths (tab-separated)
    entries=""
    while IFS= read -r path; do
        name=$(basename "$path")
        entries+="${name}\t${path}\n"
    done < <(find ~/projects -mindepth 1 -maxdepth 1 -type d)

    while IFS= read -r path; do
        project=$(basename "$(dirname "$path")")
        worktree=$(basename "$path")
        entries+="${project}/${worktree}\t${path}\n"
    done < <(find ~/worktrees -mindepth 2 -maxdepth 2 -type d)

    # Show only display name (field 1), return full line
    selection=$(echo -e "$entries" | fzf --tmux "$(popup_width),50%" --reverse --border-label=" Projects " --color=border:#bd5eff --delimiter='\t' --with-nth=1)
    # Extract full path (field 2)
    switch=$(echo "$selection" | cut -f2)
    switch-session "$switch"
    exit 0
elif [ "$EXISTING" = true ]; then
    sessions_with_status=$(get_sessions_with_status)
    selected_with_status=$(echo "$sessions_with_status" | fzf --tmux "$(popup_width),50%" --reverse --border-label=" Sessions " --color=border:#bd5eff)
    if [[ -z "$selected_with_status" ]]; then
        exit 0
    fi
    selected=$(strip_status_suffix "$selected_with_status")
    switch-session "$selected"
    exit 0
elif [ "$KILL" = true ]; then
    sessions_with_status=$(get_sessions_with_status)
    selected_with_status=$(echo "$sessions_with_status" | fzf --tmux "$(popup_width),50%" --reverse --border-label=" Kill Session " --color=border:#bd5eff)
    if [[ -z "$selected_with_status" ]]; then
        exit 0
    fi
    selected=$(strip_status_suffix "$selected_with_status")
    tmux kill-session -t "$selected"
    exit 0
elif [ "$SESSION" = true ]; then
    selected=$2
    if [ -z "$selected" ]; then
        echo "No session specified"
        usage
        exit 1
    fi
    switch-session "$selected"
    exit 0
fi
